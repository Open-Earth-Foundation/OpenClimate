# OpenClimate

Independent Climate Accounting Network in support of Paris Agreement goals

## License


Copyright 2021-2022 Open Earth Foundation and contributors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

## Setup

A self signed SSL certificate is autogenerated at nginx/ssl/my-site.com.(key|crt). You can provide your own keys here, or modify the scripts to use an alternate key.

One method is to use Let's Encrypt:

https://letsencrypt.org/


First, checkout the repository.

    git clone ...

Then get the git submodules

    git submodule update --init

The email issuer needs RECAPTCHA keys to work properly. Go to https://www.google.com/recaptcha/admin/create, add a site label, select v.2, and add the proper domain. Fill out the rest of the fields, then copy and paste the keys into the following ENV variables:

    - RECAPTCHA_SITEKEY=6Le3N9Yc12345DtL-f700RBPA312345An6rV69Fy
    - RECAPTCHA_SECRETKEY=6Le3N9Yc12345D2KO8JGJdYr12345jLRlw9WOAh5

We can finally start the docker containers by runnning

    docker-compose up

The first time you bring up the containers and agent(in a container or separate) or reset them, you must run the following script after the controller api containers have started:

    docker-compose exec hub-api npm run first-time-setup

You also want to log in and configure the SMTP settings before you attempt any process that sends emails (such as user creation or email verification). Here are some sample settings:

    Host: smtp.gmail.com
    Email: youremail@gmail.com
    Password: ******

For Gmail-based email accounts, you will need to set up an App Password by going to https://myaccount.google.com/?pli=1, selecting "Security" from the left column links, and then clicking "App Passwords" under "Signing into Google." When selecting the type of app, make sure to use "Other" and to type in a label that helps you remember what the app password was for.

To reset all the containers, you can run:

    docker-compose rm

To remove just one container, you can run something like the following:

    docker-compose rm api

If you change the agent dependencies or version, you must start the docker containers with a --build flag:

    docker-compose up --build

If you want you can run the containers detached by adding the -d command. For more details about docker-compose up, you can run

    docker-compose up --help

If you need to execute commands in one of the running containers, you can run something like the following.

    docker-compose exec db sh

In the previous case we entered the db container and ran the command sh. Tab completion is helpful in seeing the list of containers available.

    $ docker-compose exec
    api        db         ui         webserver

# Self-signed cert

When you run the system locally, you might get some errors around using a self-signed certificate
on localhost. Follow these directions to fix it.

https://stackoverflow.com/questions/7580508/getting-chrome-to-accept-self-signed-localhost-certificate

chrome://flags/#allow-insecure-localhost

# Importing data to a developer environment

Here are the steps to import data in the developer environment. One of the containers that docker-compose creates is a shell that can be used for running import scripts.

In this container, `/opt/import` includes the data importer script, and `/var/local/harmonize` is the data harmonization directory.

1. In your OpenClimate directory, run `docker-compose --profile oc exec hub-importer /bin/sh` to log into the hub-importer shell.
2. Run `cd /opt/import` to change to the importer directory.
3. Run `pip3 install psycopg2-binary` to install the PostgreSQL library for Python.
4. Run `python3 import_openclimate_data.py <data source directory>` to import a data source.

Four important directories to import, in order:

- /var/local/harmonize/data/processed/ISO-3166-1/ for countries (about 250)
- /var/local/harmonize/data/processed/Kosovo/ for this one country
- /var/local/harmonize/data/processed/ISO-3166-2/ for regions (about 5000)
- /var/local/harmonize/data/processed/UNLOCODE/ for cities (about 120,000)

This should get you a good geographical hierarchy.